    - name: Download Flannel manifest (latest)
      get_url:
        url: "https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml"
        dest: /tmp/kube-flannel-latest.yml
        force: yes
      when: flannel_version == "latest"

    - name: Download Flannel manifest (specific version)
      get_url:
        url: "https://github.com/flannel-io/flannel/releases/download/v{{ flannel_version }}/kube-flannel.yml"
        dest: /tmp/kube-flannel-{{ flannel_version }}.yml
      when: flannel_version != "latest"

    - name: Update Flannel manifest Pod CIDR if not default
      replace:
        path: "/tmp/kube-flannel-{{ flannel_version }}.yml"
        regexp: '10\.244\.0\.0/16'
        replace: "{{ pod_cidr }}"
      when: pod_cidr != "10.244.0.0/16"

    - name: Apply Flannel manifest
      command: kubectl apply -f /tmp/kube-flannel-{{ flannel_version }}.yml
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Wait for Flannel pods to be ready
      command: kubectl -n kube-flannel rollout status daemonset/kube-flannel-ds
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      retries: 20
      delay: 15
      register: flannel_rollout
      until: flannel_rollout.rc == 0

    - name: Get Flannel status
      command: kubectl get pods -n kube-flannel -l app=flannel
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: flannel_status

    - name: Show Flannel status
      debug:
        var: flannel_status.stdout
