- name: Install MetalLB
  hosts: k8s_masters[0]
  become: true

  vars_files:
    - ../vars.yaml

  vars:
    kubeconfig: /etc/kubernetes/admin.conf

  tasks:

    - block:

        - name: Add MetalLB Helm repo
          shell: |
            helm repo add metallb https://metallb.github.io/metallb
            helm repo update
          environment:
            KUBECONFIG: "{{ kubeconfig }}"

        - name: Determine MetalLB chart version
          shell: |
            if [ "{{ metallb_helm_chart_version }}" = "latest" ]; then
              helm search repo metallb/metallb --versions --devel | awk 'NR==2{print $2}'
            else
              echo "{{ metallb_helm_chart_version }}"
            fi
          register: metallb_chart_version
          changed_when: false
          environment:
            KUBECONFIG: "{{ kubeconfig }}"

        - name: Set MetalLB chart version fact
          set_fact:
            resolved_metallb_chart_version: "{{ metallb_chart_version.stdout | trim }}"

        - name: Install or upgrade MetalLB ({{ resolved_metallb_chart_version }})
          shell: |
            helm upgrade --install metallb metallb/metallb \
              --namespace metallb-system \
              --create-namespace \
              --version {{ resolved_metallb_chart_version }}
          environment:
            KUBECONFIG: "{{ kubeconfig }}"

        - name: Wait for MetalLB controller deployment
          command: kubectl -n metallb-system rollout status deployment/metallb-controller
          environment:
            KUBECONFIG: "{{ kubeconfig }}"
          retries: 20
          delay: 10
          register: metallb_controller_ready
          until: metallb_controller_ready.rc == 0

        - name: Wait for MetalLB speaker daemonset
          command: kubectl -n metallb-system rollout status daemonset/metallb-speaker
          environment:
            KUBECONFIG: "{{ kubeconfig }}"
          retries: 20
          delay: 10
          register: metallb_speaker_ready
          until: metallb_speaker_ready.rc == 0

        - name: Create IPAddressPool manifest
          copy:
            dest: /tmp/metallb-ipaddresspool.yaml
            content: |
              apiVersion: metallb.io/v1beta1
              kind: IPAddressPool
              metadata:
                name: default-address-pool
                namespace: metallb-system
              spec:
                addresses:
                  - "{{ metallb_ip_range_start }}-{{ metallb_ip_range_end }}"

        - name: Apply IPAddressPool using kubectl
          command: kubectl apply -f /tmp/metallb-ipaddresspool.yaml
          environment:
            KUBECONFIG: "{{ kubeconfig }}"

        - name: Create L2Advertisement manifest
          copy:
            dest: /tmp/metallb-l2adv.yaml
            content: |
              apiVersion: metallb.io/v1beta1
              kind: L2Advertisement
              metadata:
                name: default-l2-advertisement
                namespace: metallb-system
              spec:
                ipAddressPools:
                  - default-address-pool

        - name: Apply L2Advertisement using kubectl
          command: kubectl apply -f /tmp/metallb-l2adv.yaml
          environment:
            KUBECONFIG: "{{ kubeconfig }}"

        - name: Get MetalLB pods
          shell: kubectl get pods -n metallb-system -o wide
          environment:
            KUBECONFIG: "{{ kubeconfig }}"
          register: metallb_pods

        - name: Display MetalLB pod status
          debug:
            var: metallb_pods.stdout

      when: install_metallb | bool
