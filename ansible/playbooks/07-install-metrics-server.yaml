- name: Install Metrics Server on Kubernetes
  hosts: k8s_masters[0]
  become: yes
  vars_files:
    - ../vars.yaml
  vars:
    kubeconfig_path: /etc/kubernetes/admin.conf

  tasks:
  
    - block:

      - name: Download Metrics Server manifest (latest)
        get_url:
          url: "https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml"
          dest: /tmp/metrics-server-latest.yaml
          mode: '0644'
          force: yes
        when: metrics_server_version == "latest"

      - name: Download Metrics Server manifest (specific version)
        get_url:
          url: "https://github.com/kubernetes-sigs/metrics-server/releases/download/v{{ metrics_server_version }}/components.yaml"
          dest: /tmp/metrics-server-{{ metrics_server_version }}.yaml
          mode: '0644'
        when: metrics_server_version != "latest"

      - name: Apply Metrics Server manifest
        command: kubectl apply -f /tmp/metrics-server-{{ metrics_server_version }}.yaml --kubeconfig {{ kubeconfig_path }}
        register: apply_result
        changed_when: "'configured' not in apply_result.stdout"

      - name: Patch Metrics Server to ignore kubelet TLS verification
        command: >
          kubectl -n kube-system patch deployment metrics-server
          --type='json'
          -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
          --kubeconfig {{ kubeconfig_path }}
        register: patch_result
        failed_when: patch_result.rc not in [0,1]
        changed_when: "'patched' in patch_result.stdout or 'updated' in patch_result.stdout"

      - name: Wait for Metrics Server rollout
        command: >
          kubectl rollout status deployment/metrics-server
          -n kube-system
          --timeout=180s
          --kubeconfig {{ kubeconfig_path }}

      - name: Verify Metrics Server is running
        command: >
          kubectl get pods -n kube-system -l k8s-app=metrics-server
          --kubeconfig {{ kubeconfig_path }}
        register: metrics_pods
        changed_when: false

      - debug:
          msg: "{{ metrics_pods.stdout_lines }}"

      when: install_metrics_server | bool
